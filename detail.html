<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detail Materi | CyberDiary</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #fdf4ff, #f0f9ff);
      margin: 0;
      padding: 0;
      color: #1e293b;
    }

    .navbar {
      background: #a855f7;
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .navbar h1 { margin: 0; font-size: 20px; }
    .navbar button {
      background: white; color: #a855f7; border: none;
      padding: 8px 14px; border-radius: 8px;
      cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    .navbar button:hover { background: #f3e8ff; }

    .container {
      max-width: 900px; background: white; margin: 40px auto;
      border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      padding: 32px;
    }

    .drop-zone {
      border: 2px dashed #a855f7; border-radius: 16px;
      padding: 24px; text-align: center; color: #a855f7;
      margin-bottom: 20px; cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .drop-zone.dragover { background-color: #f3e8ff; }

    img#materiImg {
      width: 100%; border-radius: 16px; margin-bottom: 20px;
      max-height: 350px; object-fit: cover;
    }

    h1.editable, p.editable {
      border: 1px solid transparent; padding: 6px; border-radius: 8px;
      transition: 0.2s;
    }
    h1.editable:focus, p.editable:focus {
      outline: none; border-color: #a855f7; background: #f3e8ff;
    }

    .toolbar {
      display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;
    }
    button.action {
      border: none; cursor: pointer; padding: 10px 16px;
      border-radius: 10px; font-weight: 600; transition: all 0.2s ease; color: white;
    }
    #editBtn { background: #a855f7; }
    #saveBtn { background: #10b981; display: none; }
    #deleteBtn { background: #ef4444; }
    button:hover { transform: scale(1.05); }

    #materiContent { margin-top: 20px; line-height: 1.8; color: #334155; }

    footer {
      text-align: center; padding: 16px; color: #64748b;
      font-size: 14px; margin-top: 40px;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h1>üìñ CyberDiary</h1>
    <button onclick="goHome()">üè† Home</button>
  </div>

  <div class="container">
    <div class="toolbar">
      <button id="editBtn" class="action">‚úèÔ∏è Edit</button>
      <button id="saveBtn" class="action">üíæ Simpan</button>
      <button id="deleteBtn" class="action">üóë Hapus</button>
    </div>

    <div class="drop-zone" id="dropZone">
      üì∑ Drag & Drop / Paste Gambar di sini
      <input type="file" id="imageInput" accept="image/*" hidden>
    </div>
    <img id="materiImg" src="" alt="Gambar Materi">

    <h1 id="materiTitle" contenteditable="false" class="editable"></h1>
    <p id="materiDesc" contenteditable="false" class="editable"></p>
    <hr style="margin:20px 0; border:1px solid #e5e7eb;">
    <div id="materiContent"></div>
  </div>

  <footer>¬© 2025 CyberDiary ‚Äî Catatan belajar pribadi.</footer>

  <!-- üîπ Firebase Integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, get, update, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsc11I-9mRgZ6dTkqfsraOk9ia1Um8OHk",
      authDomain: "cyberdiary-27223.firebaseapp.com",
      databaseURL: "https://cyberdiary-27223-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cyberdiary-27223",
      storageBucket: "cyberdiary-27223.firebasestorage.app",
      messagingSenderId: "32458241213",
      appId: "1:32458241213:web:3a2e5fa15931096c15f3d4",
      measurementId: "G-N246T9LLQM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // üîπ Ambil ID materi yang dibuka
    const materiId = localStorage.getItem("currentMateri");
    const materiRef = ref(db, "materi/" + materiId);

    const imgElement = document.getElementById("materiImg");
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("imageInput");
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const titleEl = document.getElementById("materiTitle");
    const descEl = document.getElementById("materiDesc");
    const contentEl = document.getElementById("materiContent");
    let editor;
    let currentMateri = {};

    // üîπ Load data materi dari Firebase
    get(materiRef).then(snapshot => {
      if (snapshot.exists()) {
        currentMateri = snapshot.val();
        titleEl.innerText = currentMateri.title;
        descEl.innerText = currentMateri.desc;
        imgElement.src = currentMateri.image || "";
        contentEl.innerHTML = currentMateri.content || "<p><i>(Belum ada isi materi)</i></p>";
      } else {
        alert("Materi tidak ditemukan!");
        window.location.href = "index.html";
      }
    });

    // üîπ Fungsi kembali ke home
    window.goHome = () => window.location.href = "index.html";

    // üîπ Aktifkan edit mode
    editBtn.addEventListener("click", () => {
      titleEl.contentEditable = "true";
      descEl.contentEditable = "true";
      dropZone.style.display = "block";

      ClassicEditor.create(contentEl)
        .then(newEditor => {
          editor = newEditor;
          editBtn.style.display = "none";
          saveBtn.style.display = "inline-block";
        })
        .catch(err => console.error(err));
    });

    // üîπ Simpan ke Firebase
    saveBtn.addEventListener("click", async () => {
      const updatedData = {
        title: titleEl.innerText.trim(),
        desc: descEl.innerText.trim(),
        image: imgElement.src,
        content: editor.getData(),
      };

      await update(materiRef, updatedData);
      alert("‚úÖ Materi berhasil disimpan!");
      location.reload();
    });

    // üîπ Hapus materi
    document.getElementById("deleteBtn").addEventListener("click", async () => {
      if (confirm("Yakin ingin menghapus materi ini?")) {
        await remove(materiRef);
        alert("üóë Materi telah dihapus!");
        window.location.href = "index.html";
      }
    });

    // üîπ Upload gambar (klik, drag-drop, atau paste)
    dropZone.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => handleFile(e.target.files[0]));

    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      handleFile(e.dataTransfer.files[0]);
    });

    document.addEventListener("paste", (e) => {
      const item = e.clipboardData.items[0];
      if (item && item.type.startsWith("image/")) {
        handleFile(item.getAsFile());
      }
    });

    function handleFile(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        imgElement.src = reader.result;
      };
      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
